from util import download_with_figshare, validate_patch
import os
import json
from PIL import Image

download_lists = {'40282102': '002.tiff',  '40282099': '001.tiff', '40282096': '016.tiff', '40282105': '008.tiff', '40282111': '003.tiff', '40282108': '010.tiff', '40282114': '014.tiff',
 '40282132': '012.tiff', '40282129': '011.tiff', '40282126': '006.tiff', '40282117': '013.tiff', '40282123': '015.tiff', '40282135': '007.tiff', '40282120': '005.tiff', '40282138': '004.tiff', '40282141': '009.tiff',
 '40282144': '018.tiff', '40282147': '022.tiff', '40282153': '017.tiff', '40282150': '020.tiff', '40282162': '021.tiff', '40282156': '026.tiff', '40282159': '023.tiff', '40282165': '028.tiff', '40282180': '019.tiff',
 '40282171': '024.tiff', '40282186': '034.tiff', '40282183': '030.tiff', '40282168': '031.tiff', '40282174': '027.tiff', '40282177': '025.tiff', '40282189': '029.tiff', '40282192': '038.tiff', '40282195': '036.tiff',
 '40282198': '032.tiff', '40282204': '037.tiff', '40282207': '033.tiff', '40282201': '035.tiff', '40282210': '039.tiff', '40282213': '042.tiff', '40282225': '040.tiff','40282216': '044.tiff',  '40282219': '048.tiff', 
 '40282222': '046.tiff', '40282234': '043.tiff', '40282231': '041.tiff', '40282228': '047.tiff', '40282237': '052.tiff', '40282240': '050.tiff', '40282243': '045.tiff', '40282246': '049.tiff',  '40282252': '053.tiff',
 '40282249': '055.tiff', '40282255': '056.tiff', '40282270': '051.tiff', '40282261': '054.tiff', '40282258': '060.tiff', '40282264': '058.tiff', '40282267': '062.tiff', '40282276': '057.tiff', '40282273': '064.tiff',
 '40282279': '059.tiff', '40282282': '066.tiff', '40282288': '068.tiff', '40282285': '061.tiff', '40282291': '063.tiff', '40282294': '065.tiff', '40282297': '067.tiff', '40282300': '070.tiff', '40282303': '076.tiff',
 '40282309': '069.tiff', '40282306': '074.tiff', '40282318': '072.tiff', '40282312': '078.tiff', '40282321': '073.tiff', '40282315': '080.tiff', '40282324': '071.tiff', '40282327': '082.tiff', '40282330': '075.tiff',
 '40282333': '077.tiff', '40282336': '086.tiff', '40282339': '081.tiff', '40282342': '083.tiff', '40282351': '079.tiff', '40282357': '084.tiff', '40282345': '096.tiff', '40282348': '092.tiff', '40282354': '085.tiff',
 '40282363': '090.tiff', '40282366': '088.tiff', '40282360': '094.tiff', '40282369': '098.tiff', '40282372': '087.tiff', '40282378': '089.tiff', '40282375': '091.tiff', '40282381': '093.tiff', '40282384': '100.tiff',
 '40282387': '095.tiff', '40282390': '102.tiff', '40282393': '097.tiff', '40282396': '104.tiff', '40282405': '099.tiff', '40282408': '116.tiff', '40282402': '108.tiff', '40282414': '101.tiff', '40282417': '106.tiff',
 '40282429': '112.tiff', '40282420': '110.tiff', '40282411': '103.tiff', '40282426': '127.tiff', '40282423': '105.tiff', '40282432': '107.tiff', '40282435': '109.tiff', '40282438': '118.tiff', '40282441': '114.tiff',
 '40282444': '111.tiff', '40282447': '124.tiff', '40282450': '113.tiff', '40282453': '122.tiff', '40282459': '120.tiff', '40282456': '115.tiff', '40282462': '117.tiff', '40282465': '128.tiff', '40282468': '119.tiff',
 '40282471': '126.tiff', '40282474': '125.tiff', '40282477': '123.tiff', '40282480': '131.tiff', '40282483': '129.tiff', '40282486': '121.tiff', '40282492': '133.tiff', '40282489': '135.tiff', '40282495': '137.tiff',
 '40282501': '139.tiff', '40282498': '134.tiff', '40282504': '136.tiff', '40282507': '132.tiff', '40282516': '130.tiff', '40282510': '138.tiff', '40282513': '140.tiff', '40282519': '143.tiff', '40282522': '142.tiff',
 '40282528': '145.tiff', '40282531': '148.tiff', '40282525': '146.tiff', '40282540': '144.tiff', '40282534': '141.tiff', '40282537': '150.tiff', '40282543': '202.tiff', '40282546': '204.tiff', '40282552': '205.tiff',
 '40282549': '203.tiff', '40282555': '147.tiff', '40282558': '201.tiff', '40282564': '149.tiff', '40282561': '207.tiff', '40282570': '206.tiff', '40282573': '209.tiff', '40282567': '208.tiff', '40282576': '213.tiff',
 '40282594': '210.tiff', '40282603': '217.tiff', '40282600': '215.tiff', '40282606': '222.tiff', '40282609': '220.tiff', '40282612': '211.tiff', '40282618': '214.tiff', '40282615': '216.tiff', '40282621': '212.tiff',
 '40282624': '224.tiff', '40282627': '218.tiff', '40282630': '223.tiff', '40282639': '221.tiff', '40282633': '229.tiff', '40282636': '219.tiff', '40282642': '227.tiff', '40282648': '231.tiff', '40282645': '235.tiff',
 '40282651': '233.tiff', '40282654': '237.tiff', '40282660': '239.tiff', '40282657': '225.tiff', '40282666': '226.tiff', '40282663': '241.tiff', '40282669': '230.tiff', '40282672': '228.tiff', '40282675': '232.tiff',
 '40282678': '243.tiff', '40282681': '234.tiff', '40282684': '236.tiff', '40282687': '238.tiff', '40282690': '249.tiff', '40282693': '247.tiff', '40282696': '250.tiff', '40282699': '252.tiff', '40282705': '254.tiff',
 '40282702': '256.tiff', '40282708': '240.tiff', '40282711': '258.tiff', '40282714': '242.tiff', '40282717': '244.tiff', '40282720': '245.tiff', '40282723': '246.tiff', '40282726': '262.tiff', '40282729': '264.tiff',
 '40282732': '251.tiff', '40282741': '266.tiff', '40282738': '270.tiff', '40282735': '268.tiff', '40282759': '272.tiff', '40282744': '276.tiff', '40282747': '274.tiff', '40282753': '248.tiff', '40282756': '253.tiff',
 '40282762': '255.tiff', '40282768': '259.tiff', '40282765': '257.tiff', '40282771': '260.tiff', '40282774': '261.tiff', '40282777': '278.tiff', '40282780': '280.tiff', '40282783': '288.tiff', '40282789': '286.tiff',
 '40282786': '284.tiff', '40282792': '290.tiff', '40282813': '263.tiff', '40282795': '265.tiff', '40282798': '267.tiff', '40282801': '282.tiff', '40282804': '292.tiff', '40282807': '269.tiff', '40282810': '273.tiff',
 '40282819': '271.tiff', '40282816': '294.tiff', '40282822': '275.tiff', '40282828': '277.tiff', '40282831': '296.tiff', '40282825': '298.tiff', '40282834': '300.tiff', '40282837': '304.tiff', '40282843': '302.tiff',
 '40282840': '281.tiff', '40282846': '306.tiff', '40282849': '279.tiff', '40282852': '285.tiff', '40282858': '283.tiff', '40282861': '308.tiff', '40282855': '289.tiff', '40282864': '287.tiff', '40282867': '291.tiff',
 '40282870': '314.tiff', '40282876': '293.tiff', '40282873': '312.tiff', '40282879': '310.tiff', '40282882': '316.tiff', '40282888': '295.tiff', '40282885': '317.tiff', '40282891': '319.tiff', '40282900': '299.tiff',
 '40282894': '297.tiff', '40282897': '303.tiff', '40282903': '301.tiff', '40282906': '322.tiff', '40282909': '326.tiff', '40282921': '324.tiff', '40282912': '327.tiff', '40282915': '305.tiff', '40282918': '307.tiff',
 '40282924': '330.tiff', '40282927': '332.tiff', '40282930': '335.tiff', '40282933': '309.tiff', '40282936': '337.tiff', '40282939': '311.tiff', '40282942': '339.tiff', '40282945': '315.tiff', '40282948': '318.tiff',
 '40282951': '313.tiff', '40282954': '342.tiff', '40282957': '320.tiff', '40282960': '341.tiff', '40282969': '323.tiff', '40282963': '321.tiff', '40282966': '344.tiff', '40282972': '346.tiff', '40282975': '348.tiff',
 '40282978': '325.tiff', '40282984': '350.tiff', '40282987': '352.tiff', '40282981': '354.tiff', '40282990': '329.tiff', '40282993': '328.tiff', '40283002': '356.tiff', '40282996': '333.tiff', '40282999': '331.tiff',
 '40283005': '334.tiff', '40283008': '338.tiff', '40283014': '336.tiff', '40283017': '357.tiff', '40283020': '361.tiff', '40283023': '359.tiff', '40283032': '363.tiff', '40283029': '340.tiff', '40283026': '365.tiff',
 '40283044': '347.tiff', '40283038': '343.tiff', '40283035': '372.tiff', '40283041': '351.tiff', '40283047': '349.tiff', '40283050': '374.tiff', '40283053': '376.tiff', '40283059': '367.tiff', '40283056': '353.tiff',
 '40283062': '355.tiff', '40283065': '380.tiff', '40283068': '378.tiff', '40283071': '345.tiff', '40283074': '358.tiff', '40283077': '385.tiff', '40283080': '389.tiff', '40283089': '387.tiff', '40283083': '362.tiff',
 '40283086': '360.tiff', '40283092': '366.tiff', '40283104': '397.tiff', '40283098': '391.tiff', '40283107': '393.tiff', '40283095': '368.tiff', '40283101': '364.tiff', '40283110': '395.tiff', '40283119': '369.tiff',
 '40283113': '371.tiff', '40283116': '370.tiff', '40283122': '399.tiff', '40283125': '402.tiff', '40283128': '404.tiff', '40283131': '373.tiff', '40283134': '375.tiff', '40283137': '377.tiff', '40283140': '410.tiff',
 '40283143': '408.tiff', '40283155': '413.tiff', '40283152': '415.tiff', '40283146': '379.tiff', '40283149': '381.tiff', '40283158': '382.tiff', '40283161': '417.tiff', '40283164': '406.tiff', '40283167': '383.tiff',
 '40283170': '419.tiff', '40283176': '421.tiff', '40283173': '388.tiff', '40283179': '384.tiff', '40283182': '390.tiff', '40283188': '386.tiff', '40283194': '423.tiff', '40283200': '392.tiff', '40283221': '429.tiff',
 '40283206': '431.tiff', '40283242': '427.tiff', '40283212': '425.tiff', '40283236': '394.tiff', '40283224': '432.tiff', '40283245': '396.tiff', '40283257': '433.tiff', '40283263': '435.tiff', '40283278': '398.tiff',
 '40283287': '400.tiff', '40283293': '401.tiff', '40283302': '403.tiff', '40283311': '405.tiff', '40283320': '436.tiff', '40283326': '407.tiff', '40283329': '438.tiff', '40283332': '440.tiff', '40283335': '409.tiff',
 '40283338': '411.tiff', '40283344': '442.tiff', '40283341': '444.tiff', '40283350': '412.tiff', '40283347': '446.tiff', '40283353': '450.tiff', '40283356': '448.tiff', '40283365': '414.tiff', '40283362': '416.tiff',
 '40283359': '452.tiff', '40283368': '418.tiff', '40283371': '420.tiff', '40283374': '454.tiff', '40283377': '456.tiff', '40283386': '422.tiff', '40283380': '426.tiff', '40283383': '457.tiff', '40283389': '424.tiff',
 '40283392': '428.tiff', '40283395': '461.tiff', '40283401': '459.tiff', '40283407': '430.tiff', '40283410': '464.tiff', '40283413': '466.tiff', '40283416': '468.tiff', '40283419': '434.tiff', '40283425': '439.tiff',
 '40283422': '470.tiff', '40283428': '437.tiff', '40283434': '441.tiff', '40283437': '472.tiff', '40283431': '445.tiff', '40283443': '474.tiff', '40283449': '476.tiff', '40283440': '443.tiff', '40283446': '447.tiff',
 '40283452': '449.tiff', '40283458': '478.tiff', '40283455': '482.tiff', '40283461': '451.tiff', '40283464': '480.tiff', '40283473': '455.tiff', '40283467': '486.tiff', '40283476': '484.tiff', '40283479': '453.tiff',
 '40283491': '492.tiff', '40283482': '491.tiff', '40283488': '458.tiff', '40283494': '489.tiff', '40283497': '460.tiff', '40283503': '463.tiff', '40283500': '494.tiff', '40283509': '462.tiff', '40283506': '465.tiff',
 '40283512': '497.tiff', '40283515': '501.tiff', '40283521': '467.tiff', '40283518': '499.tiff', '40283524': '469.tiff', '40283527': '471.tiff', '40283533': '503.tiff', '40283530': '505.tiff', '40283539': '473.tiff',
 '40283536': '475.tiff', '40283548': '507.tiff', '40283545': '477.tiff', '40283542': '509.tiff', '40283554': '511.tiff', '40283557': '514.tiff', '40283563': '479.tiff', '40283560': '481.tiff', '40283566': '515.tiff',
 '40283569': '517.tiff', '40283572': '483.tiff', '40283575': '487.tiff', '40283584': '520.tiff', '40283587': '488.tiff', '40283593': '485.tiff', '40283581': '522.tiff', '40283578': '524.tiff', '40283596': '490.tiff',
 '40283599': '493.tiff', '40283602': '526.tiff', '40283611': '528.tiff', '40283608': '530.tiff', '40283605': '495.tiff', '40283614': '496.tiff', '40283617': '498.tiff', '40283620': '532.tiff', '40283623': '535.tiff',
 '40283632': '500.tiff', '40283629': '538.tiff', '40283635': '540.tiff', '40283638': '542.tiff', '40283641': '502.tiff', '40283644': '504.tiff', '40283647': '506.tiff', '40283653': '544.tiff', '40283650': '508.tiff',
 '40283659': '548.tiff', '40283656': '510.tiff', '40283665': '546.tiff', '40283662': '550.tiff', '40283668': '512.tiff', '40283677': '513.tiff', '40283671': '552.tiff', '40283674': '516.tiff', '40283680': '518.tiff',
 '40283683': '521.tiff', '40283689': '519.tiff', '40283686': '523.tiff', '40283692': '525.tiff', '40283695': '527.tiff', '40283698': '531.tiff','40283701': '529.tiff', '40283704': '533.tiff', '40283707': '534.tiff',
 '40283710': '537.tiff', '40283716': '541.tiff', '40283719': '536.tiff', '40283713': '539.tiff', '40283722': '543.tiff', '40283725': '545.tiff', '40283728': '547.tiff', '40283731': '549.tiff', '40283734': '551.tiff',
 '40283740': '553.tiff', '41265615': 'MIDOGpp.json'}

print('Downloading 65 GB - this may take a while ...')

domain_split = [('1a', 0, 50, ''), ('1b', 50, 100, 'csid'), ('1c', 100, 150, 'csid'), ('2', 200, 244, 'near'), ('3', 244, 299, 'near'), ('4', 299, 349, 'near'), ('5', 349, 404, 'near'), ('6a', 404, 489, 'near'), ('6b', 489, 504, 'near'), ('7', 504, 553, 'near')]

script_dir = os.path.dirname(os.path.abspath(__file__))

root = f'{script_dir}/../../../data/midog/'
all_found = True
for domain in domain_split:
    domain_name = domain[0]
    subfolder = domain[3]
    dir_path = os.path.join(root, subfolder, domain_name)    
    if not os.path.exists(dir_path):
        all_found = False
        break

if not all_found:
    download_path = f'{script_dir}/tmp/midog'
    download_with_figshare(download_lists, download_path)

    midog_data = json.load(open(os.path.join(download_path, 'MIDOGpp.json')))    

    for domain in domain_split:
        domain_name = domain[0]
        start = domain[1]
        end = domain[2]
        subfolder = domain[3]
    
        print(f"\nProcessing domain {domain_name}...")
        out_dir = os.path.join(root, subfolder, domain_name)
        os.makedirs(out_dir, exist_ok=True)
        for img_index in range(start, end):
            img_data = midog_data['images'][img_index]
            img_name = img_data['file_name']
            print(f"Processing img {img_name}...", end='\r')
            img_id = img_data['id']
            img_dir = os.path.join(out_dir, f"{img_id:03d}")
            os.makedirs(img_dir, exist_ok=True)
            image = Image.open(os.path.join(download_path, img_name))
            img_dims = (img_data['width'], img_data['height'])
            # Get all Annotations with img_id
            annotations = [ann for ann in midog_data['annotations'] if ann['image_id'] == img_id]
            for annotation in annotations:
                label = annotation['category_id']
                bbox = annotation['bbox']
                ann_id = annotation['id']
                # Check if the bbox has a width and height of exactly 50 px
                if bbox[2] - bbox[0] == 50 and bbox[3] - bbox[1] == 50:
                    # Crop the image
                    crop = image.crop(bbox)
                    # Save the crop
                    crop.save(os.path.join(img_dir, f"{img_id:03d}_{ann_id}_{label}.tiff"))

                    # The additional bbox will be used to create patches that show background or normal cells
                    additional_bbox = [bbox[0]+100, bbox[1], bbox[2]+100, bbox[3]]
                    # Validate the additional bbox
                    if validate_patch(img_dims, annotations, additional_bbox):
                        # Crop the image
                        crop = image.crop(additional_bbox)
                        label = 0
                        # Save the crop
                        crop.save(os.path.join(img_dir, f"{img_id:03d}_{ann_id}_{label}.tiff"))
                else:
                    # These boxes will be ignored
                    pass

print('MIDOG: Processing complete')

